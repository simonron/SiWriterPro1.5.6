function touchHandler(e){if("touchstart"==e.type){for(var t=0;t<e.touches.length;t++){var i=e.touches[t].identifier,n=e.touches[t].target;if($(n).hasClass("deferTouch")){var s=$(n).closest(".touchMX, .touchMY, .touchRot, .touchSca");s&&s.length>0?n=s[0]:(console.log("multitouch-simplifier: could not deferTouch for >>"),console.log(n))}void 0===n.xfm_tx&&(n.xfm_tx=0),void 0===n.xfm_ty&&(n.xfm_ty=0),void 0===n.xfm_r&&(n.xfm_r=0),void 0===n.xfm_s&&(n.xfm_s=1),n.accel_x=0,n.accel_y=0;var a=getTouchElementInfo(n);n.posX=a.x,n.posY=a.y,movingObjects[i]={identifier:i,target:n,mouse:{x:e.touches[t].clientX,y:e.touches[t].clientY},position:{x:n.xfm_tx,y:n.xfm_ty},rotation:n.xfm_r,scale:n.xfm_s,rotateScaleMode:!0},updateTransform(n),$(n).hasClass("touchTop")&&(movingObjects[i].target.style.zIndex=zIndexCount++),movingObjects[i].rotateScaleMode=!1;var o=e.touches[t].target.onTouchDown;void 0!==o&&o(getTouchElementInfo(n))}touchStartFn(e)}else if("touchmove"==e.type){if(2==e.touches.length&&null!==movingObjects[e.touches[0].identifier]&&null!==movingObjects[e.touches[1].identifier]&&movingObjects[e.touches[0].identifier].target==movingObjects[e.touches[1].identifier].target&&($(movingObjects[e.touches[0].identifier].target).hasClass("touchRot")||$(movingObjects[e.touches[0].identifier].target).hasClass("touchSca")||$(movingObjects[e.touches[0].identifier].target).hasClass("touchMRequiresTwo"))){var r=e.touches[0].identifier,u=e.touches[1].identifier;if(movingObjects[r].rotateScaleMode&&movingObjects[u].rotateScaleMode){if($(movingObjects[r].target).hasClass("touchMX")){var l=movingObjects[r].positionCenter.x-movingObjects[r].mouseCenter.x+(e.touches[0].clientX+e.touches[1].clientX)/2,h=l-movingObjects[r].target.xfm_tx;movingObjects[r].target.accel_x=(movingObjects[r].target.accel_x+h)/2,movingObjects[r].target.xfm_tx=l}if($(movingObjects[r].target).hasClass("touchMY")){var c=movingObjects[r].positionCenter.y-movingObjects[r].mouseCenter.y+(e.touches[0].clientY+e.touches[1].clientY)/2,d=c-movingObjects[r].target.xfm_ty;movingObjects[i].target.accel_y=(movingObjects[r].target.accel_y+d)/2,movingObjects[r].target.xfm_ty=c}$(movingObjects[r].target).hasClass("touchRot")&&(movingObjects[r].target.xfm_r=movingObjects[r].rotation+e.rotation),$(movingObjects[r].target).hasClass("touchSca")&&(movingObjects[r].target.xfm_s=movingObjects[r].scale*e.scale),updateTransform(movingObjects[r].target)}else movingObjects[r].rotateScaleMode=movingObjects[u].rotateScaleMode=!0,movingObjects[r].mouseCenter=movingObjects[u].mouseCenter={x:(e.touches[0].clientX+e.touches[1].clientX)/2,y:(e.touches[0].clientY+e.touches[1].clientY)/2},movingObjects[r].positionCenter=movingObjects[u].positionCenter={x:movingObjects[r].target.xfm_tx,y:movingObjects[r].target.xfm_ty}}else for(var t=0;t<e.touches.length;t++){var i=e.touches[t].identifier;if(movingObjects[i]){if(movingObjects[i].rotateScaleMode=!1,!$(movingObjects[i].target).hasClass("touchMRequiresTwo")){if($(movingObjects[i].target).hasClass("touchMX")){var l=movingObjects[i].position.x-movingObjects[i].mouse.x+e.touches[t].clientX,h=l-movingObjects[i].target.xfm_tx;movingObjects[i].target.accel_x=(movingObjects[i].target.accel_x+h)/2,movingObjects[i].target.xfm_tx=l}if($(movingObjects[i].target).hasClass("touchMY")){var c=movingObjects[i].position.y-movingObjects[i].mouse.y+e.touches[t].clientY,d=c-movingObjects[i].target.xfm_ty;movingObjects[i].target.accel_y=(movingObjects[i].target.accel_y+d)/2,movingObjects[i].target.xfm_ty=c}}updateTransform(movingObjects[i].target)}}for(objID in movingObjects){var p=movingObjects[objID].target,v=0,f=1e5,m=0,g=1e5,_=.5,w=2,a=getTouchElementInfo(p);if($(p).hasClass("boundMX")){var b=p.getAttribute("minBX"),y=p.getAttribute("maxBX");void 0!==b&&(v=b),void 0!==y&&(f=y),setTouchElementPos(p,Math.max(v,Math.min(f,a.x)),a.y)}if($(p).hasClass("boundMY")){var T=p.getAttribute("minBY"),x=p.getAttribute("maxBY");void 0!==T&&(m=T),void 0!==x&&(g=x),setTouchElementPos(p,a.x,Math.max(m,Math.min(g,a.y)))}if($(p).hasClass("boundSca")){var P=p.getAttribute("minSca"),D=p.getAttribute("maxSca");void 0!==P&&(_=P),void 0!==D&&(w=D),setTouchElementScale(p,Math.max(_,Math.min(w,p.xfm_s)))}var o=p.onTouchMove;void 0!==o&&o(getTouchElementInfo(p))}touchMoveFn(e)}else if("touchend"==e.type||"touchcancel"==e.type){for(var i in movingObjects){for(var S=!1,t=0;t<e.touches.length;t++)e.touches[t].identifier===movingObjects[i].identifier&&(S=!0);if(0==S){updateTransform(movingObjects[i].target);var o=movingObjects[i].target.onTouchUp;void 0!==o&&o(getTouchElementInfo(movingObjects[i].target)),delete movingObjects[i]}}"touchend"==e.type&&touchEndFn(e),"touchcancel"==e.type&&touchCancel(e)}e.preventDefault()}function setTouchElementPos(e,t,i){var n=parseInt(getStyle(e,"left"),10),s=parseInt(getStyle(e,"top"),10);n>-1e5&&1e5>n||(n=0),s>-1e5&&1e5>s||(s=0),e.xfm_tx=t-n,e.xfm_ty=i-s,updateTransform(e)}function setTouchElementScale(e,t){e.xfm_s=t,updateTransform(e)}function getTouchElementInfo(e){var t=parseInt(getStyle(e,"left"),10),i=parseInt(getStyle(e,"top"),10),n=1,s=0,a=0,o=0;return t>-1e5&&1e5>t||(t=0),i>-1e5&&1e5>i||(i=0),void 0!==e.xfm_tx&&(t+=e.xfm_tx),void 0!==e.xfm_ty&&(i+=e.xfm_ty),void 0!==e.accel_x&&(a=e.accel_x),void 0!==e.accel_y&&(o=e.accel_y),void 0!==e.xfm_s&&(n=e.xfm_s),void 0!==e.xfm_r&&(s+=e.xfm_r),{x:t,y:i,s:n,r:s,ax:a,ay:o}}function updateTransform(e){e.style["-webkit-transform"]="translate("+e.xfm_tx+"px,"+e.xfm_ty+"px) scale("+e.xfm_s+") rotate("+e.xfm_r+"deg)",e.style.MozTransform="translate("+e.xfm_tx+"px,"+e.xfm_ty+"px) scale("+e.xfm_s+") rotate("+e.xfm_r+"deg)",e.posX=parseInt(e.style.left)+e.xfm_tx,e.posY=parseInt(e.style.top)+e.xfm_ty}function initTouch(e,t,i,n){e&&(touchStartFn=e),t&&(touchMoveFn=t),i&&(touchEndFn=i),n&&(touchCancelFn=n),document.addEventListener("touchstart",touchHandler,!1),document.addEventListener("touchmove",touchHandler,!1),document.addEventListener("touchend",touchHandler,!1),document.addEventListener("touchcancel",touchHandler,!1)}var touchStartFn=function(){},touchMoveFn=function(){},touchEndFn=function(){},touchCancelFn=function(){},BBB,zIndexCount=1,movingObjects={};